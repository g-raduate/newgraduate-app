import 'package:flutter/material.dart';
import 'package:url_launcher/url_launcher.dart';

class ProjectDetailsScreen extends StatelessWidget {
  final String type;
  final String title;
  final String description;
  final List<String> examples;
  final List<String> howToWrite;
  final String? whatsappMessage;

  const ProjectDetailsScreen({
    super.key,
    required this.type,
    required this.title,
    required this.description,
    required this.examples,
    required this.howToWrite,
    this.whatsappMessage,
  });

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    return Scaffold(
      appBar: AppBar(
        title: Text(title),
        centerTitle: true,
      ),
      body: SingleChildScrollView(
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            Container(
              width: double.infinity,
              color: theme.colorScheme.primaryContainer.withOpacity(0.15),
              padding: const EdgeInsets.symmetric(vertical: 32, horizontal: 24),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color:
                          theme.colorScheme.primaryContainer.withOpacity(0.3),
                      shape: BoxShape.circle,
                    ),
                    child: Icon(
                      type == 'software'
                          ? Icons.computer_rounded
                          : type == 'hardware'
                              ? Icons.memory_rounded
                              : Icons.hub_rounded,
                      size: 40,
                      color: theme.colorScheme.primary,
                    ),
                  ),
                  const SizedBox(height: 20),
                  Text(
                    title,
                    style: theme.textTheme.headlineSmall?.copyWith(
                      fontWeight: FontWeight.bold,
                      color: theme.colorScheme.primary,
                    ),
                    textAlign: TextAlign.center,
                  ),
                ],
              ),
            ),
            Padding(
              padding: const EdgeInsets.all(24),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    description,
                    style: theme.textTheme.bodyLarge,
                    textAlign: TextAlign.justify,
                  ),
                  const SizedBox(height: 24),
                  _buildSection(
                    theme,
                    'ÿ£ŸÖÿ´ŸÑÿ©',
                    examples,
                    Icons.lightbulb_outline,
                  ),
                  const SizedBox(height: 24),
                  _buildSection(
                    theme,
                    'ŸÉŸäŸÅ ÿ™ŸÉÿ™ÿ® ŸÖÿ¥ÿ±ŸàÿπŸÉ ŸÑŸÑŸÖÿ®ÿ±ŸÖÿ¨/ÿßŸÑŸÖÿ¥ÿ±ŸÅÿü',
                    howToWrite,
                    Icons.edit_note,
                  ),
                  const SizedBox(height: 32),
                  // Centered contact button with max width
                  Align(
                    alignment: Alignment.center,
                    child: ConstrainedBox(
                      constraints: const BoxConstraints(maxWidth: 200),
                      child: ElevatedButton.icon(
                        onPressed: () => _showContactDialog(context),
                        icon: const Icon(Icons.message_outlined),
                        label: const Text(
                          'ÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÜÿß',
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        style: ElevatedButton.styleFrom(
                          padding: const EdgeInsets.symmetric(
                              vertical: 14, horizontal: 12),
                          backgroundColor: theme.colorScheme.primary,
                          foregroundColor: theme.colorScheme.onPrimary,
                          elevation: 2,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildSection(
    ThemeData theme,
    String title,
    List<String> items,
    IconData icon,
  ) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: theme.colorScheme.primaryContainer.withOpacity(0.1),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: theme.colorScheme.primaryContainer,
          width: 1,
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                padding: const EdgeInsets.all(8),
                decoration: BoxDecoration(
                  color: theme.colorScheme.primaryContainer,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Icon(
                  icon,
                  color: theme.colorScheme.primary,
                  size: 20,
                ),
              ),
              const SizedBox(width: 12),
              // Use Expanded to avoid overflow for long Arabic titles
              Expanded(
                child: Text(
                  title,
                  style: theme.textTheme.titleLarge?.copyWith(
                    fontWeight: FontWeight.bold,
                    color: theme.colorScheme.primary,
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          ...items
              .map((item) => Padding(
                    padding:
                        const EdgeInsets.only(bottom: 12, right: 4, left: 4),
                    child: Row(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          'üîπ',
                          style: theme.textTheme.titleMedium,
                        ),
                        const SizedBox(width: 12),
                        Expanded(
                          child: Text(
                            item,
                            style: theme.textTheme.bodyLarge?.copyWith(
                              height: 1.5,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ))
              .toList(),
        ],
      ),
    );
  }

  void _showContactDialog(BuildContext context) {
    showDialog(
      context: context,
      builder: (ctx) {
        // Dialog stateful builder to manage radio selection and conditional fields
        int selection = 0; // 0 = fill form, 1 = only name, 2 = no idea
        final TextEditingController studentNameController =
            TextEditingController();
        final TextEditingController projectNameController =
            TextEditingController();
        final TextEditingController mainIdeaController =
            TextEditingController();
        final TextEditingController requiredFeaturesController =
            TextEditingController();
        final TextEditingController targetUsersController =
            TextEditingController();

        return StatefulBuilder(
          builder: (context, setState) {
            return AlertDialog(
              title: const Text('ÿ™ŸàÿßÿµŸÑ ÿπÿ®ÿ± Ÿàÿßÿ™ÿ≥ÿßÿ®'),
              content: SingleChildScrollView(
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // Radio options
                    RadioListTile<int>(
                      value: 0,
                      groupValue: selection,
                      onChanged: (v) => setState(() => selection = v ?? 0),
                      title: const Text('ŸÖŸÑÿ° ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨'),
                    ),
                    RadioListTile<int>(
                      value: 1,
                      groupValue: selection,
                      onChanged: (v) => setState(() => selection = v ?? 1),
                      title: const Text('ŸÑÿØŸä ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸÅŸÇÿ∑'),
                    ),
                    RadioListTile<int>(
                      value: 2,
                      groupValue: selection,
                      onChanged: (v) => setState(() => selection = v ?? 2),
                      title: const Text('ŸÑÿß ÿ£ŸÖŸÑŸÉ ŸÅŸÉÿ±ÿ© ÿ≠ÿßŸÑŸäÿßŸã'),
                    ),

                    const SizedBox(height: 8),

                    // Conditional fields
                    if (selection == 0) ...[
                      const Text('ÿßÿ≥ŸÖ ÿßŸÑÿ∑ÿßŸÑÿ®'),
                      const SizedBox(height: 6),
                      TextField(
                        controller: studentNameController,
                        decoration: InputDecoration(
                          hintText: 'ŸÖÿ´ÿßŸÑ: ÿ£ÿ≠ŸÖÿØ ÿπŸÑŸä',
                          hintStyle:
                              TextStyle(color: Theme.of(context).hintColor),
                        ),
                      ),
                      const SizedBox(height: 10),
                      const Text('ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ'),
                      const SizedBox(height: 6),
                      TextField(
                        controller: projectNameController,
                        decoration: InputDecoration(
                          hintText: 'ŸÖÿ´ÿßŸÑ: ŸÜÿ∏ÿßŸÖ ÿ•ÿ∑ŸÅÿßÿ° ÿ∞ŸÉŸä ŸÑŸÑŸÖŸÜÿßÿ≤ŸÑ',
                          hintStyle:
                              TextStyle(color: Theme.of(context).hintColor),
                        ),
                      ),
                      const SizedBox(height: 10),
                      const Text('ÿßŸÑŸÅŸÉÿ±ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© ÿ®ÿßÿÆÿ™ÿµÿßÿ±'),
                      const SizedBox(height: 6),
                      TextField(
                        controller: mainIdeaController,
                        decoration: InputDecoration(
                          hintText:
                              'ŸÖÿ´ÿßŸÑ: ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ∏ÿßŸÖ ŸÑÿ±ÿµÿØ ÿßŸÑÿ≠ÿ±ŸäŸÇ Ÿàÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ•ŸÜÿ∞ÿßÿ± ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß',
                          hintStyle:
                              TextStyle(color: Theme.of(context).hintColor),
                        ),
                      ),
                      const SizedBox(height: 10),
                      const Text('ÿßŸÑŸàÿ∏ÿßÿ¶ŸÅ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©'),
                      const SizedBox(height: 6),
                      TextField(
                        controller: requiredFeaturesController,
                        decoration: InputDecoration(
                          hintText:
                              'ŸÖÿ´ÿßŸÑ: ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑÿå ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸäÿßŸÜÿßÿ™ÿå ÿ™ŸÇÿßÿ±Ÿäÿ±...',
                          hintStyle:
                              TextStyle(color: Theme.of(context).hintColor),
                        ),
                      ),
                      const SizedBox(height: 10),
                      const Text('ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸàŸÜ ÿßŸÑŸÖÿ≥ÿ™ŸáÿØŸÅŸàŸÜ'),
                      const SizedBox(height: 6),
                      TextField(
                        controller: targetUsersController,
                        decoration: InputDecoration(
                          hintText: 'ŸÖÿ´ÿßŸÑ: ÿ∑ŸÑÿßÿ®ÿå ŸÖŸàÿßÿ∑ŸÜŸàŸÜÿå ŸÖŸàÿ∏ŸÅŸàŸÜ',
                          hintStyle:
                              TextStyle(color: Theme.of(context).hintColor),
                        ),
                      ),
                    ] else if (selection == 1) ...[
                      const Text('ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ'),
                      const SizedBox(height: 6),
                      TextField(
                        controller: projectNameController,
                        decoration: InputDecoration(
                          hintText: 'ŸÖÿ´ÿßŸÑ: ŸÜÿ∏ÿßŸÖ ÿ•ÿ∑ŸÅÿßÿ° ÿ∞ŸÉŸä ŸÑŸÑŸÖŸÜÿßÿ≤ŸÑ',
                          hintStyle:
                              TextStyle(color: Theme.of(context).hintColor),
                        ),
                      ),
                    ] else ...[
                      const Text('ŸÑŸÜ ÿ™ÿ≠ÿ™ÿßÿ¨ ŸÑÿ•ÿØÿÆÿßŸÑ ÿ£Ÿä ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¢ŸÜ.'),
                    ],
                  ],
                ),
              ),
              actions: [
                TextButton(
                  onPressed: () {
                    studentNameController.dispose();
                    projectNameController.dispose();
                    mainIdeaController.dispose();
                    requiredFeaturesController.dispose();
                    Navigator.of(ctx).pop();
                  },
                  child: const Text('ÿ•ŸÑÿ∫ÿßÿ°'),
                ),
                ElevatedButton(
                  onPressed: () {
                    // Build the message depending on selection
                    String message = '';
                    if (selection == 2) {
                      message = 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÑÿß ŸäŸÖŸÑŸÉ ŸÅŸÉÿ±ÿ© ÿ≠ÿßŸÑŸäÿßŸã.';
                    } else if (selection == 1) {
                      final name = projectNameController.text.trim();
                      final target = targetUsersController.text.trim();
                      message =
                          'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ: ${name.isEmpty ? '(ŸÑŸÖ ŸäŸèÿØÿÆŸÑ ÿßÿ≥ŸÖ)' : name}';
                      if (target.isNotEmpty) {
                        message += '\nÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸàŸÜ ÿßŸÑŸÖÿ≥ÿ™ŸáÿØŸÅŸàŸÜ: $target';
                      }
                    } else {
                      final student = studentNameController.text.trim();
                      final project = projectNameController.text.trim();
                      final idea = mainIdeaController.text.trim();
                      final features = requiredFeaturesController.text.trim();
                      final target = targetUsersController.text.trim();
                      message =
                          'ÿßÿ≥ŸÖ ÿßŸÑÿ∑ÿßŸÑÿ®: ${student.isEmpty ? '(ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ)' : student}\n'
                          'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ: ${project.isEmpty ? '(ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ)' : project}\n'
                          'ÿßŸÑŸÅŸÉÿ±ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©: ${idea.isEmpty ? '(ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ)' : idea}\n'
                          'ÿßŸÑŸàÿ∏ÿßÿ¶ŸÅ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©: ${features.isEmpty ? '(ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ)' : features}';
                      if (target.isNotEmpty) {
                        message += '\nÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸàŸÜ ÿßŸÑŸÖÿ≥ÿ™ŸáÿØŸÅŸàŸÜ: $target';
                      }
                    }

                    // Convert provided local number to international ‚Äî assumption: country code +964 (Iraq)
                    const String whatsappNumber = '+9647748687725';
                    // If a template whatsappMessage is provided for this project, prepend it
                    String finalMessage = '';
                    if (whatsappMessage != null &&
                        whatsappMessage!.isNotEmpty) {
                      finalMessage = '${whatsappMessage!}\n\n$message';
                    } else {
                      finalMessage = message;
                    }

                    final encoded = Uri.encodeComponent(finalMessage);
                    final Uri whatsappUri = Uri.parse(
                        'https://api.whatsapp.com/send?phone=$whatsappNumber&text=$encoded');

                    if (context.mounted) {
                      Navigator.of(ctx).pop();
                    }

                    // Try to launch WhatsApp URL; if fails show the message in a SnackBar
                    launchUrl(whatsappUri).then((ok) {
                      if (!ok && context.mounted) {
                        ScaffoldMessenger.of(context).showSnackBar(
                          SnackBar(
                              content:
                                  Text('ÿ™ÿπÿ∞ÿ± ŸÅÿ™ÿ≠ Ÿàÿßÿ™ÿ≥ÿßÿ®. ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©:\n$message')),
                        );
                      }
                    }).catchError((_) {
                      if (context.mounted) {
                        ScaffoldMessenger.of(context).showSnackBar(
                          SnackBar(
                              content:
                                  Text('ÿ™ÿπÿ∞ÿ± ŸÅÿ™ÿ≠ Ÿàÿßÿ™ÿ≥ÿßÿ®. ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©:\n$message')),
                        );
                      }
                    }).whenComplete(() {
                      studentNameController.dispose();
                      projectNameController.dispose();
                      mainIdeaController.dispose();
                      requiredFeaturesController.dispose();
                      targetUsersController.dispose();
                    });
                  },
                  child: const Text('ÿ•ÿ±ÿ≥ÿßŸÑ'),
                ),
              ],
            );
          },
        );
      },
    );
  }
}
